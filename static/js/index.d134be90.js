(()=>{"use strict";var e={9639:function(e,t,r){let n,i,a,o;var s,c=r(813),l=r(5826),d=r(9056);class h extends Error{constructor(e){super(e),this.name="IDBCacheError",Object.setPrototypeOf(this,new.target.prototype)}}class u extends h{constructor(e){super(e),this.name="DatabaseError"}}class m extends h{constructor(e){super(e),this.name="CryptoError"}}class p extends h{constructor(e){super(e),this.name="WorkerInitializationError"}}class f extends h{constructor(e){super(e),this.name="EncryptionError"}}class w extends h{constructor(e){super(e),this.name="DecryptionError"}}class y extends h{constructor(e){super(e),this.name="TimeoutError"}}function x(e,t){e.forEach((r,n)=>{r.reject(new p(t)),clearTimeout(r.timer),e.delete(n)})}async function g(e,t,r,n,i,a=5e3){return new Promise((o,s)=>{let c=setTimeout(()=>{let e=n.get(t);e&&(e.reject(new y("Request timed out")),n.delete(t))},a);n.set(t,{resolve:o,reject:s,timer:c});let l=[];i&&i.length>0&&l.push(...i);try{l.length>0?e.postMessage(r,l):e.postMessage(r)}catch(r){console.error("Failed to post message to SharedWorker:",r);let e=n.get(t);e&&(clearTimeout(e.timer),e.reject(new p("Failed to communicate with the SharedWorker.")),n.delete(t));return}})}async function k(e,t,r){let n=crypto.randomUUID();try{return await g(e,n,{requestId:n,type:"encrypt",payload:{value:t}},r,[],5e3)}catch(e){if(e instanceof p||e instanceof f||e instanceof h)throw e;throw new f(e instanceof Error?e.message:"Unknown encryption error")}}async function b(e,t,r,n){let i=crypto.randomUUID();try{return await g(e,i,{requestId:i,type:"decrypt",payload:{iv:t,ciphertext:r}},n,[t,r],5e3)}catch(e){if(e instanceof p||e instanceof w||e instanceof h)throw e;throw new w(e instanceof Error?e.message:"Unknown decryption error")}}let v=(e,t)=>t.some(t=>e instanceof t),j=new WeakMap,I=new WeakMap,C=new WeakMap,S={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return j.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return E(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function E(e){if(e instanceof IDBRequest){let t=new Promise((t,r)=>{let n=()=>{e.removeEventListener("success",i),e.removeEventListener("error",a)},i=()=>{t(E(e.result)),n()},a=()=>{r(e.error),n()};e.addEventListener("success",i),e.addEventListener("error",a)});return C.set(t,e),t}if(I.has(e))return I.get(e);let t=function(e){if("function"==typeof e)return(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(D(this),t),E(this.request)}:function(...t){return E(e.apply(D(this),t))};return(e instanceof IDBTransaction&&function(e){if(j.has(e))return;let t=new Promise((t,r)=>{let n=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",a),e.removeEventListener("abort",a)},i=()=>{t(),n()},a=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",i),e.addEventListener("error",a),e.addEventListener("abort",a)});j.set(e,t)}(e),v(e,n||(n=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])))?new Proxy(e,S):e}(e);return t!==e&&(I.set(e,t),C.set(t,e)),t}let D=e=>C.get(e);function $(e,t,{blocked:r,upgrade:n,blocking:i,terminated:a}={}){let o=indexedDB.open(e,t),s=E(o);return n&&o.addEventListener("upgradeneeded",e=>{n(E(o.result),e.oldVersion,e.newVersion,E(o.transaction),e)}),r&&o.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),s.then(e=>{a&&e.addEventListener("close",()=>a()),i&&e.addEventListener("versionchange",e=>i(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}let B=["get","getKey","getAll","getAllKeys","count"],M=["put","add","delete","clear"],z=new Map;function P(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(z.get(t))return z.get(t);let r=t.replace(/FromIndex$/,""),n=t!==r,i=M.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!(i||B.includes(r)))return;let a=async function(e,...t){let a=this.transaction(e,i?"readwrite":"readonly"),o=a.store;return n&&(o=o.index(t.shift())),(await Promise.all([o[r](...t),i&&a.done]))[0]};return z.set(t,a),a}S={...a=S,get:(e,t,r)=>P(e,t)||a.get(e,t,r),has:(e,t)=>!!P(e,t)||a.has(e,t)};let T=["continue","continuePrimaryKey","advance"],L={},W=new WeakMap,R=new WeakMap,N={get(e,t){if(!T.includes(t))return e[t];let r=L[t];return r||(r=L[t]=function(...e){W.set(this,R.get(this)[t](...e))}),r}};async function*O(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;let r=new Proxy(t,N);for(R.set(r,t),C.set(r,D(t));t;)yield r,t=await (W.get(r)||t.continue()),W.delete(r)}function A(e,t){return t===Symbol.asyncIterator&&v(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&v(e,[IDBIndex,IDBObjectStore])}function K(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}S={...o=S,get:(e,t,r)=>A(e,t)?O:o.get(e,t,r),has:(e,t)=>A(e,t)||o.has(e,t)};let U=new class{get(e){if(!this.cache.has(e))return;let t=this.cache.get(e);if(void 0!==t)return this.cache.delete(e),this.cache.set(e,t),t}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){let e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}this.cache.set(e,t)}has(e){return this.cache.has(e)}constructor(e=1e4){K(this,"maxSize",void 0),K(this,"cache",void 0),this.maxSize=e,this.cache=new Map}}(1e3);function F(){return new Promise(e=>requestAnimationFrame(e))}async function q(e,t="normal"){if(U.has(e)){let t=U.get(e);if("string"==typeof t)return t}let r=new TextEncoder().encode(e);"low"===t&&await F();let n=function(e){if(!/^[0-9a-fA-F]{128}$/.test(e))throw Error("Invalid hash: Must be a 128-character hexadecimal string");return[e.slice(0,8),e.slice(8,12),`5${e.slice(13,16)}`,(3&Number.parseInt(e.slice(16,17),16)|8).toString(16)+e.slice(17,20),e.slice(20,32)].join("-")}(function(e){let t=new Uint8Array(e),r="";for(let e of t)r+=e.toString(16).padStart(2,"0");return r}(await crypto.subtle.digest("SHA-512",r)));return U.set(e,n),n}async function G(e,t,r){let n=[],i=e.transaction(t,"readonly"),a=i.store,o=`${r}-chunk-000000-`,s=`${r}-chunk-999999\uffff`,c=IDBKeyRange.bound(o,s,!1,!1),l=await a.openKeyCursor(c);for(;l;)n.push(l.key),l=await l.continue();return await i.done,n}function V(e,t){if(!e.objectStoreNames.contains(t)){let r=e.createObjectStore(t,{keyPath:"key"});r.createIndex("byTimestamp","timestamp"),r.createIndex("byCacheBuster","cacheBuster")}}async function _(e,t,r){try{return await F(),await $(e,r,{upgrade(e){V(e,t)}})}catch(n){if(n instanceof DOMException&&"VersionError"===n.name)return console.warn(`VersionError: Deleting database ${e} and retrying...`),await function(e,{blocked:t}={}){let r=indexedDB.deleteDatabase(e);return t&&r.addEventListener("blocked",e=>t(e.oldVersion,e)),E(r).then(()=>void 0)}(e),await F(),await $(e,r,{upgrade(e){V(e,t)}});throw n}}function Y(){let e=null,t=new Map,r=1e5,n=null;async function i(e){if(!n)throw Error("Fixed salt (cacheBuster) not initialized");let i=`${new TextDecoder().decode(e)}-${new TextDecoder().decode(new Uint8Array(n))}`;if(t.has(i)){let e=t.get(i);if(void 0!==e)return e}let a=await crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveKey"]),o=await crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:r,hash:"SHA-512"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return t.set(i,o),o}async function a(t){if(!e)throw Error("Cache key not provided for encryption worker");try{t.postMessage({type:"ready"})}catch(r){console.error("Worker: Failed to initialize AES key:",r);let e=r instanceof Error?r.message:"Unknown initialization error";t.postMessage({type:"initError",error:e})}}async function o(t){if(!e)throw Error("Cache key not initialized");if(!n)throw Error("Fixed salt (cacheBuster) not initialized");let r=crypto.getRandomValues(new Uint8Array(12)),a=new TextEncoder,o=await i(e),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,a.encode(t));return{iv:r.buffer,ciphertext:s}}async function s(t,r){if(!e)throw Error("AES key not initialized");if(!n)throw Error("Fixed salt (cacheBuster) not initialized");let a=new Uint8Array(t),o=await i(e),s=await crypto.subtle.decrypt({name:"AES-GCM",iv:a},o,r);return new TextDecoder().decode(s)}let c=[],l=1,d=0;function h(e){c.push(e),u()}async function u(){for(;d<l&&c.length>0;){let e=c.shift();e&&(d++,(async()=>{let t=performance.now();try{await e()}catch(e){console.error("Worker: Task execution error:",e)}finally{var r;(r=performance.now()-t)<40&&l<10?l++:r>80&&l>1&&l--,d--,u()}})())}}self.onconnect=function(t){let i=t.ports[0];i.onmessage=t=>{let{type:c,payload:l,requestId:d}=t.data;switch(c){case"initialize":{let{cacheKey:t,pbkdf2Iterations:o,cacheBuster:s}=l;t||(t=crypto.randomUUID()),e=new TextEncoder().encode(t),r=o||1e5,n=new TextEncoder().encode(s).buffer,a(i).catch(e=>{console.error("Worker: Initialization failed:",e)})}break;case"encrypt":{let{value:e}=l;h(async()=>{try{let t=await o(e);if(!i)throw Error("MessagePort is not available");i.postMessage({requestId:d,type:"encryptResult",result:t},[t.iv,t.ciphertext])}catch(t){console.error("Worker: Encryption error:",t);let e=t instanceof Error?t.message:"Unknown encryption error";i&&i.postMessage({requestId:d,type:"error",error:e})}})}break;case"decrypt":{let{iv:e,ciphertext:t}=l;h(async()=>{try{let r=await s(e,t);if(!i)throw Error("MessagePort is not available");i.postMessage({requestId:d,type:"decryptResult",result:r})}catch(t){console.error("Worker: Decryption error:",t);let e=t instanceof Error?t.message:"Unknown decryption error";i&&i.postMessage({requestId:d,type:"error",error:e})}})}break;default:console.warn(`Worker: Unknown message type received: ${c}. Ignoring the message.`)}},i.start()}}function H(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let Z=null==(s=crypto)?void 0:s.subtle;class X{async initWorker(e,t){if(this.workerReadyPromise)return this.workerReadyPromise;this.workerReadyPromise=new Promise((r,n)=>{var i;let{worker:a,port:o}=function(e,t){let r,n,i=btoa(`(${e.toString()})()`),a=`data:application/javascript;base64,${i}`,o={name:"idb-cache-worker"};return"SharedWorker"in window?(n=(r=new SharedWorker(a,o)).port).start():n=r=new Worker(a,o),r.onerror=e=>{console.error("SharedWorker encountered an error:",e.message),t("SharedWorker encountered an error and was terminated."),r instanceof SharedWorker?r.port.close():r.terminate()},n.onmessageerror=()=>{console.warn("MessagePort encountered a message error. SharedWorker may have been terminated."),t("SharedWorker was terminated unexpectedly."),n instanceof MessagePort?n.close():n.terminate()},{worker:r,port:n}}(Y,e=>{n(new p(e)),x(this.pendingRequests,e)});this.worker=a,this.port=o,i=this.pendingRequests,o.onmessage=e=>{let t=e.data;if("ready"===t.type)r();else if("initError"===t.type)n(new p(t.error)),x(i,t.error);else if("encryptResult"===t.type&&"string"==typeof t.requestId){let{requestId:e,result:r}=t,n=i.get(e);n&&(clearTimeout(n.timer),n.resolve(r),i.delete(e))}else if("decryptResult"===t.type&&"string"==typeof t.requestId){let{requestId:e,result:r}=t,n=i.get(e);n&&(clearTimeout(n.timer),n.resolve(r),i.delete(e))}else if("error"===t.type&&"string"==typeof t.requestId){let{requestId:e,error:r}=t,n=i.get(e);if(n){let t,a=r.toLowerCase();t=a.includes("encrypt")?new f(r):a.includes("decrypt")?new w(r):a.includes("key")?new m(r):new h(r),clearTimeout(n.timer),n.reject(t),i.delete(e)}}else console.warn("WorkerUtils: Unknown message type received. Ignoring the message.",t)},o.onmessageerror=e=>{console.error("SharedWorker encountered a message error:",e),n(new p("SharedWorker failed to communicate properly.")),x(i,"SharedWorker encountered an error and was terminated."),o instanceof MessagePort?o.close():o.terminate()},o.postMessage({type:"initialize",payload:{cacheKey:e,cacheBuster:t,pbkdf2Iterations:this.pbkdf2Iterations}})});try{await this.workerReadyPromise}catch(e){if(console.error("Worker failed to initialize:",e),e instanceof h)throw e;throw new p("Worker failed to initialize.")}}async cleanup(){try{let e=await this.dbReadyPromise;"low"===this.priority&&await F();let t=e.transaction(this.storeName,"readwrite"),r=t.store,n=r.index("byTimestamp"),i=r.index("byCacheBuster"),a=Date.now(),o=await n.openCursor();for(;o;){let{timestamp:e}=o.value;if(e<=a){let t=a-e;this.debug&&console.debug(`Deleting expired item with timestamp ${e}. It is ${t}ms older than the expiration.`),o.delete()}else break;o=await o.continue()}let s=this.cacheBuster,c=IDBKeyRange.upperBound(s,!0),l=IDBKeyRange.lowerBound(s,!0),d=async e=>{let t=0,r=await i.openCursor(e);for(;r;)this.debug&&console.debug("Deleting item with cacheBuster:",r.value.cacheBuster),r.delete(),t++,r=await r.continue();return t},h=await Promise.all([d(c),d(l)]);if(void 0!==this.maxTotalChunks){let e=await r.count();if(e>this.maxTotalChunks){let t=e-this.maxTotalChunks;this.debug&&console.debug(`Total chunks (${e}) exceed maxTotalChunks (${this.maxTotalChunks}). Deleting entire items until excess (${t}) is removed.`);let i=[],a=[],o=await n.openCursor(null,"next");for(;o&&t>0;){let e=o.value.key.match(/^(.*)-chunk-\d{6}-.*/);if(!e){o=await o.continue();continue}let n=e[1];if(i.includes(n)){o=await o.continue();continue}let s=`${n}-chunk-000000-`,c=`${n}-chunk-999999\u{FFFF}`,l=IDBKeyRange.bound(s,c,!1,!1),d=[],h=await r.openCursor(l);for(;h;)d.push(h.value.key),h=await h.continue();a.push(...d),t-=d.length,i.push(n),o=await o.continue()}for(let e of a)r.delete(e),this.debug&&console.debug(`Deleted chunk ${e}.`);this.debug&&console.debug(`Deleted ${a.length} chunks by removing ${i.length} items to enforce maxTotalChunks.`)}else this.debug&&console.debug(`Total chunks (${e}) within maxTotalChunks (${this.maxTotalChunks}). No excess cleanup needed.`)}await t.done,this.debug&&h.reduce((e,t)=>e+(t||0),0)>0&&console.debug("Flushed old cache items with different cacheBuster.")}catch(e){if(console.error("Error during cleanup:",e),e instanceof u)throw e;throw new u("Failed to clean up the cache.")}}async ensureWorkerInitialized(){if(!this.workerReadyPromise)throw new p("Worker is not initialized.");await this.workerReadyPromise}getPort(){if(!this.port)throw new p("Worker port is not initialized.");return this.port}async getItem(e){try{let t=Date.now();if(!this.dbReadyPromise)return null;await this.ensureWorkerInitialized(),"low"===this.priority&&await F();let r=await this.dbReadyPromise,n=await q(`${this.cacheKey}:${e}`),i=Date.now(),a=await G(r,this.storeName,n);if(this.debug&&(0===a.length?console.debug(`Cache miss for key ${e}`):console.debug(`Cache hit for key ${e}`)),0===a.length)return null;let o=[],s=-1,c=!1;for(let t of a){let n=await r.get(this.storeName,t);if(!n)continue;if(n.timestamp<=i)return await this.removeItem(e),null;if(n.cacheBuster!==this.cacheBuster)continue;let a=function(e){let t=e.split("-chunk-");return t.length<2?-1:Number.parseInt(t[1].split("-")[0],10)}(t);a>s&&(s=a),n.isLastChunk&&(c=!0),o.push({index:a,data:n})}if(0===o.length)return null;if(!c)throw new h(`Integrity check failed for key ${e}: Last chunk is missing.`);if(o.length!==s+1)throw new h(`Integrity check failed for key ${e}: Expected ${s+1} chunks, but found ${o.length}.`);let l=new Set(o.map(e=>e.index));for(let t=0;t<=s;t++)if(!l.has(t))throw new h(`Integrity check failed for key ${e}: Missing chunk at index ${t}.`);o.sort((e,t)=>e.index-t.index);let d=await Promise.all(o.map(({data:{iv:e,ciphertext:t}})=>b(this.getPort(),e,t,this.pendingRequests))),u=Date.now()-t;return this.debug&&u>200&&console.debug(`getItem for key ${e} took ${u}ms`),d.join("")}catch(t){if(t instanceof h)throw console.error(`Integrity check failed for key ${e}:`,t),t;if(t instanceof w)throw console.error(`Decryption failed for key ${e}:`,t),t;if(t instanceof u)throw console.error(`Database error while getting key ${e}:`,t),t;if(t instanceof p)throw console.error(`Worker initialization error while getting key ${e}:`,t),t;if(t instanceof h)throw console.error(`IDBCache error while getting key ${e}:`,t),t;throw console.error(`Unexpected error while getting key ${e}:`,t),new h("An unexpected error occurred.")}}async setItem(e,t){try{let r=Date.now();if(!this.dbReadyPromise)return;if(await this.ensureWorkerInitialized(),void 0!==this.maxTotalChunks){let e=Math.ceil(t.length/this.chunkSize);if(e>this.maxTotalChunks)throw new h(`Cannot store item: chunks needed (${e}) exceeds maxTotalChunks (${this.maxTotalChunks})`)}"low"===this.priority&&await F();let n=await this.dbReadyPromise,i=await q(`${this.cacheKey}:${e}`),a=Date.now()+this.maxAge;"low"===this.priority&&await F();let o=await G(n,this.storeName,i),s=new Set(o),c=new Set,l=[],d=[],u=Math.ceil(t.length/this.chunkSize);for(let e=0;e<t.length;e+=this.chunkSize){let r=t.slice(e,e+this.chunkSize),o=Math.floor(e/this.chunkSize);"low"===this.priority&&await F();let h=await q(`${this.cacheKey}:${this.cacheBuster}:${r}`,this.priority),m=`${i}-chunk-${String(o).padStart(6,"0")}-${h}`;c.add(m);let p=o===u-1;if(s.has(m)){let e=await n.get(this.storeName,m);e&&d.push({...e,timestamp:a,cacheBuster:this.cacheBuster,isLastChunk:p})}else{"low"===this.priority&&await F();let e=await k(this.getPort(),r,this.pendingRequests);l.push({chunkKey:m,encryptedChunk:{...e,cacheBuster:this.cacheBuster,isLastChunk:p}})}}let m=o.filter(e=>!c.has(e)),p=n.transaction(this.storeName,"readwrite"),f=p.store,w=[];for(let e of d)w.push(f.put(e));for(let{chunkKey:e,encryptedChunk:t}of l)w.push(f.put({...t,key:e,timestamp:a}));for(let e of m)w.push(f.delete(e));await Promise.all(w),"low"===this.priority&&await F(),await p.done;let y=Date.now()-r;this.debug&&y>200&&console.debug(`setItem for key ${e} took ${y}ms`)}catch(e){if(e instanceof p)throw console.error("Worker port is not initialized:",e),e;if(e instanceof u)throw console.error("Database error in setItem:",e),e;if(e instanceof f)throw console.error("Encryption error in setItem:",e),e;if(e instanceof h)throw console.error("IDBCache error in setItem:",e),e;throw console.error("Unexpected error in setItem:",e),new h("An unexpected error occurred during setItem.")}}async removeItem(e){try{let t=await this.dbReadyPromise,r=await q(`${this.cacheKey}:${e}`),n=await G(t,this.storeName,r),i=t.transaction(this.storeName,"readwrite"),a=i.store,o=n.map(e=>a.delete(e));await Promise.all(o),await i.done}catch(e){if(console.error("Error in removeItem:",e),e instanceof u||e instanceof h)throw e;throw new u("Failed to remove item from the cache.")}}async count(){try{let e=(await this.dbReadyPromise).transaction(this.storeName,"readonly"),t=e.store,r=await t.count();return await e.done,this.debug&&console.debug(`Total entries in cache: ${r}`),r}catch(e){if(console.error("Error in count():",e),e instanceof u)throw e;throw new u("Failed to count items in the cache.")}}async clear(){try{let e=(await this.dbReadyPromise).transaction(this.storeName,"readwrite"),t=e.store;await t.clear(),await e.done,this.debug&&console.debug("All items have been cleared from the cache.")}catch(e){if(console.error("Error in clear:",e),e instanceof u||e instanceof h)throw e;throw new u("Failed to clear the cache.")}}async destroy(e){let{clearData:t=!1}=e||{};try{t&&await this.clear(),void 0!==this.cleanupIntervalId&&clearInterval(this.cleanupIntervalId),this.pendingRequests.forEach((e,t)=>{e.reject(new h("IDBCache instance is being destroyed.")),this.pendingRequests.delete(t)}),this.port&&(this.port=null),this.worker&&(this.worker instanceof SharedWorker?this.worker.port.close():this.worker.terminate(),this.worker=null),this.workerReadyPromise=null,this.debug&&console.debug("IDBCache instance has been destroyed.")}catch(e){if(console.error("Error in destroy:",e),e instanceof h)throw e;throw new h("Failed to destroy the cache instance.")}}constructor(e){H(this,"dbReadyPromise",void 0),H(this,"storeName",void 0),H(this,"worker",null),H(this,"port",null),H(this,"pendingRequests",void 0),H(this,"workerReadyPromise",null),H(this,"maxAge",void 0),H(this,"cleanupIntervalId",void 0),H(this,"cacheKey",void 0),H(this,"cacheBuster",void 0),H(this,"chunkSize",void 0),H(this,"cleanupInterval",void 0),H(this,"pbkdf2Iterations",void 0),H(this,"debug",void 0),H(this,"maxTotalChunks",void 0),H(this,"priority","normal");let{cacheKey:t,cacheBuster:r,debug:n=!1,dbName:i="idb-cache",maxAge:a=6048e5,chunkSize:o=25e3,cleanupInterval:s=6e4,pbkdf2Iterations:c=1e5,maxTotalChunks:l,priority:d="normal"}=e;if(this.storeName="cache",this.cacheKey=t,this.cacheBuster=r||"",this.debug=n,this.maxAge=a,this.chunkSize=o,this.cleanupInterval=s,this.pbkdf2Iterations=c,this.maxTotalChunks=l,this.pendingRequests=new Map,this.priority=d,!window.indexedDB)throw new u("IndexedDB is not supported.");if(!Z)throw new m("Web Crypto API not available in this environment");this.dbReadyPromise=_(i,this.storeName,2),this.cleanupIntervalId=window.setInterval(async()=>{try{await this.cleanup()}catch(e){console.error("Error during cleanup:",e)}},this.cleanupInterval),this.initWorker(t,r).then(()=>{setTimeout(()=>{this.cleanup().catch(e=>console.error("Initial cleanup failed:",e))},1e4)}).catch(e=>{console.error("Worker initialization failed:",e)})}}function J(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r)|0;return Math.abs(t).toString(36)}var Q=r(3107),ee=r(6908),et=r(6192),er=r(7198),en=r(5179),ei=r(1265);function ea(){return(0,c.jsxs)("a",{href:"https://github.com/instructure/idb-cache","aria-label":"View source on GitHub",children:[(0,c.jsxs)("svg",{width:80,height:80,viewBox:"0 0 250 250",style:{fill:"#151513",color:"#fff",position:"absolute",top:0,border:0,right:0},"aria-hidden":"true",children:[(0,c.jsx)("path",{d:"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"}),(0,c.jsx)("path",{d:"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2",fill:"currentColor",style:{transformOrigin:"130px 106px"},className:"octo-arm"}),(0,c.jsx)("path",{d:"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z",fill:"currentColor",className:"octo-body"})]}),(0,c.jsx)("span",{style:{position:"absolute",left:"-9999px"},children:"View source on GitHub"})]})}function eo(){return(0,c.jsx)("span",{style:{color:"#ddd"},children:"------"})}var es=r(8636),ec=r(6497),el=r(4187);function ed(e){let{cacheKey:t}=e;return(0,c.jsxs)(er.kC,{alignItems:"end",children:[(0,c.jsx)(er.kC.Item,{shouldGrow:!0,children:(0,c.jsx)(ec.o,{renderLabel:(0,c.jsxs)(er.kC,{alignItems:"end",children:[(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(et.G,{margin:"0 xx-small 0 0",children:"Cache key"})}),(0,c.jsx)(el.u,{color:"primary-inverse",renderTip:"Sensitive identifier used for securely encrypting data.",offsetY:"5px",children:(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(es.W,{})})})]}),interaction:"disabled",defaultValue:t})}),(0,c.jsx)(er.kC.Item,{children:(0,c.jsx)(Q.z,{"aria-label":"Reset cache key",margin:"0 0 0 xxx-small","data-testid":"reset-cacheKey",onClick:()=>{localStorage.removeItem("cacheKey"),localStorage.removeItem("keyCounter"),window.location.reload()},children:"Reset"})})]})}function eh(e){let{cacheBuster:t}=e;return(0,c.jsxs)(er.kC,{alignItems:"end",children:[(0,c.jsx)(er.kC.Item,{shouldGrow:!0,children:(0,c.jsx)(ec.o,{renderLabel:(0,c.jsxs)(er.kC,{alignItems:"end",children:[(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(et.G,{margin:"0 xx-small 0 0",children:"Cache buster"})}),(0,c.jsx)(el.u,{color:"primary-inverse",renderTip:"Unique value (not sensitive) used to invalidate old cache entries.",offsetY:"5px",children:(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(es.W,{})})})]}),interaction:"disabled",defaultValue:t})}),(0,c.jsx)(er.kC.Item,{children:(0,c.jsx)(Q.z,{"aria-label":"Reset cache buster",margin:"0 0 0 xxx-small","data-testid":"reset-cacheBuster",onClick:()=>{localStorage.removeItem("cacheBuster"),localStorage.removeItem("keyCounter"),window.location.reload()},children:"Reset"})})]})}function eu(e){let{children:t}=e;return(0,c.jsx)("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"flex-start",gap:"1.5rem"},children:t})}function em(e){let{children:t}=e;return(0,c.jsx)("div",{style:{flex:"1 1 calc(50% - 1rem)",minWidth:"300px",boxSizing:"border-box"},children:t})}function ep(e){let{children:t}=e;return(0,c.jsx)(et.G,{as:"div",display:"block",margin:"small none",padding:"medium",background:"primary",shadow:"resting",children:(0,c.jsx)(er.kC,{direction:"column",children:t})})}async function ef(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";return new Promise((r,n)=>{let i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),a=function(e){let t=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(t))}(`(${(()=>{self.onmessage=e=>{var t;let r,{requestId:n,targetSizeInBytes:i,seed:a}=e.data,o=(r=function(e){let t=0;for(let r=0;r<e.length;r++)t=31*t+e.charCodeAt(r)>>>0;return t}(a),function(){return(r=1664525*r+0x3c6ef35f>>>0)/0x100000000}),s=Math.ceil(i),c=Array(s);for(let e=0;e<s;e++)c[e]=String.fromCharCode(33+Math.floor(94*o()));let l=c.join("");for(;t=l,new TextEncoder().encode(t).length>i;)l=l.slice(0,-1);postMessage({requestId:n,text:l})}}).toString()})();`),o=e=>{let t=e.data;t.requestId===i&&(r(t.text),c())},s=e=>{n(e),c()},c=()=>{a.removeEventListener("message",o),a.removeEventListener("error",s),a.terminate()};a.addEventListener("message",o),a.addEventListener("error",s),a.postMessage({requestId:i,targetSizeInBytes:e,seed:t})})}var ew=r(4191),ey=r(1770);let ex=localStorage.cacheKey;ex||(ex=crypto.randomUUID(),localStorage.cacheKey=ex);let eg=localStorage.cacheBuster;eg||(eg=crypto.randomUUID(),localStorage.cacheBuster=eg);let ek=()=>{let e=Number.parseInt(new URLSearchParams(window.location.hash.slice(1)).get("size")??"0",10);return!Number.isNaN(e)&&e>0?1024*e:32768},eb=document.getElementById("root");eb&&d.createRoot(eb).render((0,c.jsx)(l.StrictMode,{children:(0,c.jsx)(()=>{let[e,t]=(0,l.useState)(null),[r,n]=(0,l.useState)(null),[i,a]=(0,l.useState)(null),[o,s]=(0,l.useState)(null),[d,h]=(0,l.useState)(null),[u,m]=(0,l.useState)(null),[p,f]=(0,l.useState)(null),[w,y]=(0,l.useState)(null),[x,g]=(0,l.useState)(ek()),[k,b]=(0,l.useState)(25600),[v,j]=(0,l.useState)(null),[I,C]=(0,l.useState)(()=>{let e=localStorage.maxTotalChunksStored;return e?Number.parseInt(e,10):5e3}),[S,E]=(0,l.useState)(()=>{let e=localStorage.priority;return["normal","low"].includes(e)?e:"normal"}),[D,$]=(0,l.useState)(!1);(0,l.useEffect)(()=>{let e=new URLSearchParams(window.location.hash.slice(1));e.set("size",String(Math.round(x/1024))),window.location.hash=`#${e.toString()}`},[x]);let B=(0,l.useRef)(Number.parseInt(localStorage.getItem("keyCounter")||"0")||0),[M,z]=(0,l.useState)(()=>J(`seed-${B.current}`)),P=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=!1;return(async()=>{if(P.current){$(!1);try{await P.current.destroy()}catch(e){console.error("Error destroying previous cache:",e)}}try{let t=new X({cacheKey:ex,cacheBuster:eg,debug:!0,chunkSize:k,maxTotalChunks:I,priority:S});e?await t.destroy():(P.current=t,$(!0))}catch(t){console.error("Error initializing cache:",t),e||$(!1)}})(),()=>{e=!0,P.current&&(P.current.destroy().catch(e=>{console.error("Error destroying cache on cleanup:",e)}),P.current=null,$(!1))}},[k,I,S]),(0,l.useEffect)(()=>{localStorage.setItem("maxTotalChunksStored",String(I))},[I]),(0,l.useEffect)(()=>{localStorage.setItem("priority",String(S))},[S]);let T=(0,l.useCallback)(async()=>{let e=P.current;if(!e)return void console.error("Cache is not initialized.");let r=J(`seed-${B.current}`);localStorage.setItem("keyCounter",String(B.current)),B.current+=1,z(r);let n=performance.now();try{let i=await Promise.all(Array.from({length:1},(e,t)=>ef(x,`${r}-${t}`))),o=performance.now();a(o-n),await new Promise(e=>requestAnimationFrame(e));let c=performance.now();for(let t=0;t<1;t++)await e.setItem(`item-${r}-${t}`,i[t]);let l=performance.now();s(l-c),t(J(i.join("")))}catch(e){console.error("Error during text generation and storage:",e)}},[x]),L=(0,l.useCallback)(async()=>{let e=P.current;if(!e)return void console.error("Cache is not initialized.");try{await new Promise(e=>requestAnimationFrame(e));let t=[],r=performance.now();for(let r=0;r<1;r++){let n=await e.getItem(`item-${M}-${r}`);t.push(n)}let i=performance.now();h(i-r),n(t.filter(e=>e).length>0?J(t.join("")):null)}catch(e){console.error("Error during text retrieval and decryption:",e)}},[M]),W=(0,l.useCallback)(async()=>{let e=P.current;if(!e)return void console.error("Cache is not initialized.");try{await new Promise(e=>requestAnimationFrame(e));let t=performance.now();await e.cleanup();let r=performance.now();f(r-t)}catch(e){console.error("Error during cache cleanup:",e)}},[]),R=(0,l.useCallback)(async()=>{let e=P.current;if(!e)return void console.error("Cache is not initialized.");try{await new Promise(e=>requestAnimationFrame(e));let t=performance.now(),r=await e.count(),n=performance.now();m(n-t),j(r)}catch(e){console.error("Error during cache count:",e)}},[]),N=(0,l.useCallback)(async()=>{let e=P.current;if(!e)return void console.error("Cache is not initialized.");try{await new Promise(e=>requestAnimationFrame(e));let t=performance.now();await e.clear(),localStorage.removeItem("keyCounter");let r=performance.now();y(r-t)}catch(e){console.error("Error during cache clear:",e)}},[]);return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(ea,{}),(0,c.jsx)("div",{className:"min-h-screen bg-gray-50 p-8",children:(0,c.jsxs)(et.G,{as:"div",display:"block",width:"820px",margin:"0 auto",children:[(0,c.jsxs)("h1",{style:{fontSize:"clamp(1.8rem, 4vw, 2.4rem)",whiteSpace:"nowrap",marginBottom:"1rem"},children:["@instructure/idb-cache (","1.1.8",")"]}),(0,c.jsxs)("form",{children:[(0,c.jsxs)(eu,{children:[(0,c.jsx)(em,{children:(0,c.jsx)(ed,{cacheKey:ex})}),(0,c.jsx)(em,{children:(0,c.jsx)(eh,{cacheBuster:eg})}),(0,c.jsx)(em,{children:(0,c.jsx)(ei.Y,{"data-testid":"item-size-input",renderLabel:(0,c.jsxs)(er.kC,{alignItems:"end",direction:"row",children:[(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(et.G,{margin:"0 xx-small 0 0",children:"Item size (KiB)"})}),(0,c.jsx)(el.u,{color:"primary-inverse",renderTip:"When an item exceeds this size, it splits into multiple chunks.",offsetY:"5px",children:(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(es.W,{})})})]}),onChange:e=>{g(Math.max(1024*Number.parseInt(e.target.value||"0",10),1024))},onIncrement:()=>{g(e=>Math.max(e+1024,1024))},onDecrement:()=>{g(e=>Math.max(e-1024,1024))},value:Math.round(x/1024)})}),(0,c.jsx)(em,{children:(0,c.jsx)(ei.Y,{renderLabel:"Chunks per item:",interaction:"disabled",value:Math.ceil(x/k)})}),(0,c.jsx)(em,{children:(0,c.jsx)(ei.Y,{disabled:!0,renderLabel:"Chunk size (KiB)",onChange:e=>{b(Math.max(1024*Number.parseInt(e.target.value||"0",10),1024))},onIncrement:()=>{b(e=>Math.max(e+1024,1024))},onDecrement:()=>{b(e=>Math.max(e-1024,1024))},value:Math.round(k/1024)})}),(0,c.jsx)(em,{children:(0,c.jsx)(ei.Y,{"data-testid":"max-chunks-input",renderLabel:(0,c.jsxs)(er.kC,{alignItems:"end",children:[(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(et.G,{margin:"0 xx-small 0 0",children:"Max total chunks"})}),(0,c.jsx)(el.u,{color:"primary-inverse",renderTip:"During cleanup, idb-cache removes the oldest surplus chunks.",offsetY:"5px",children:(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(es.W,{})})})]}),onChange:e=>{C(Number.parseInt(e.target.value||"0",10)||1)},onIncrement:()=>{C(e=>Math.max(e+1,1))},onDecrement:()=>{C(e=>Math.max(e-1,1))},value:I})}),(0,c.jsx)(em,{children:(0,c.jsxs)(ew.a,{name:"priority",value:S,"data-testid":"priority-input",description:(0,c.jsxs)(er.kC,{alignItems:"end",children:[(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(et.G,{margin:"0 xx-small 0 0",children:"Priority"})}),(0,c.jsx)(el.u,{color:"primary-inverse",renderTip:"Low priority slightly delays start of operations to reduce load on event loop.",offsetY:"5px",children:(0,c.jsx)(er.kC.Item,{as:"div",children:(0,c.jsx)(es.W,{})})})]}),variant:"toggle",onChange:e=>{E("low"===e.target.value?"low":"normal")},children:[(0,c.jsx)(ey.N,{label:"Normal",value:"normal"}),(0,c.jsx)(ey.N,{label:"Low",value:"low"})]})})]}),(0,c.jsx)(en.X,{level:"h2",margin:"medium 0 small 0",children:"Tests"}),(0,c.jsxs)(ep,{children:[(0,c.jsx)(Q.z,{"data-testid":"set-item-button",color:"primary",onClick:T,disabled:!D,children:"setItem"}),(0,c.jsx)(et.G,{padding:"medium 0 0 0",children:(0,c.jsxs)(er.kC,{children:[(0,c.jsx)(er.kC.Item,{size:"33.3%",children:(0,c.jsx)(ee.j,{renderLabel:"fixtures","data-testid":"generate-time",renderValue:null!==i?`${Math.round(i)} ms`:(0,c.jsx)(eo,{})})}),(0,c.jsx)(er.kC.Item,{shouldGrow:!0,children:(0,c.jsx)(ee.j,{renderLabel:"setItem","data-testid":"set-time",renderValue:null!==o?`${Math.round(o)} ms`:(0,c.jsx)(eo,{})})}),(0,c.jsx)(er.kC.Item,{size:"33.3%",children:(0,c.jsx)(ee.j,{"data-testid":"hash1",renderLabel:"hash",renderValue:e||(0,c.jsx)(eo,{})})})]})})]}),(0,c.jsxs)(ep,{children:[(0,c.jsx)(Q.z,{"data-testid":"get-item-button",color:"primary",onClick:L,disabled:!D,children:"getItem"}),(0,c.jsx)(et.G,{padding:"medium 0 0 0",children:(0,c.jsxs)(er.kC,{children:[(0,c.jsx)(er.kC.Item,{size:"33.3%",children:"\xa0"}),(0,c.jsx)(er.kC.Item,{shouldGrow:!0,children:(0,c.jsx)(ee.j,{renderLabel:"getItem","data-testid":"get-time",renderValue:null!==d?`${Math.round(d)} ms`:(0,c.jsx)(eo,{})})}),(0,c.jsx)(er.kC.Item,{size:"33.3%",children:(0,c.jsx)(ee.j,{renderLabel:"hash","data-testid":"hash2",renderValue:r||(0,c.jsx)(eo,{})})})]})})]}),(0,c.jsxs)(ep,{children:[(0,c.jsx)(Q.z,{"data-testid":"count-button",color:"primary",onClick:R,disabled:!D,children:"count"}),(0,c.jsx)(et.G,{padding:"medium 0 0 0",children:(0,c.jsxs)(er.kC,{children:[(0,c.jsx)(er.kC.Item,{size:"33.3%",children:"\xa0"}),(0,c.jsx)(er.kC.Item,{shouldGrow:!0,children:(0,c.jsx)(ee.j,{renderLabel:"count","data-testid":"count-time",renderValue:null!==u?`${Math.round(u)} ms`:(0,c.jsx)(eo,{})})}),(0,c.jsx)(er.kC.Item,{size:"33.3%",children:(0,c.jsx)(ee.j,{renderLabel:"chunks","data-testid":"count-value",renderValue:"number"==typeof v?v:(0,c.jsx)(eo,{})})})]})})]}),(0,c.jsxs)(ep,{children:[(0,c.jsx)(Q.z,{"data-testid":"cleanup-button",color:"primary",onClick:W,disabled:!D,children:"cleanup"}),(0,c.jsx)(et.G,{padding:"medium 0 0 0",children:(0,c.jsxs)(er.kC,{children:[(0,c.jsx)(er.kC.Item,{size:"33.3%",children:"\xa0"}),(0,c.jsx)(er.kC.Item,{shouldGrow:!0,children:(0,c.jsx)(ee.j,{renderLabel:"cleanup","data-testid":"cleanup-time",renderValue:null!==p?`${Math.round(p)} ms`:(0,c.jsx)(eo,{})})}),(0,c.jsx)(er.kC.Item,{size:"33.3%",children:"\xa0"})]})})]}),(0,c.jsxs)(ep,{children:[(0,c.jsx)(Q.z,{"data-testid":"clear-button",color:"primary",onClick:N,disabled:!D,children:"clear"}),(0,c.jsx)(et.G,{padding:"medium 0 0 0",children:(0,c.jsxs)(er.kC,{children:[(0,c.jsx)(er.kC.Item,{size:"33.3%",children:"\xa0"}),(0,c.jsx)(er.kC.Item,{shouldGrow:!0,children:(0,c.jsx)(ee.j,{renderLabel:"clear","data-testid":"clear-time",renderValue:null!==w?`${Math.round(w)} ms`:(0,c.jsx)(eo,{})})}),(0,c.jsx)(er.kC.Item,{size:"33.3%",children:"\xa0"})]})})]})]})]})})]})},{})}))}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,r),a.exports}r.m=e,r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},(()=>{var e,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__;r.t=function(n,i){if(1&i&&(n=this(n)),8&i||"object"==typeof n&&n&&(4&i&&n.__esModule||16&i&&"function"==typeof n.then))return n;var a=Object.create(null);r.r(a);var o={};e=e||[null,t({}),t([]),t(t)];for(var s=2&i&&n;"object"==typeof s&&!~e.indexOf(s);s=t(s))Object.getOwnPropertyNames(s).forEach(e=>{o[e]=()=>n[e]});return o.default=()=>n,r.d(a,o),a}})(),r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e=[];r.O=(t,n,i,a)=>{if(n){a=a||0;for(var o=e.length;o>0&&e[o-1][2]>a;o--)e[o]=e[o-1];e[o]=[n,i,a];return}for(var s=1/0,o=0;o<e.length;o++){for(var[n,i,a]=e[o],c=!0,l=0;l<n.length;l++)(!1&a||s>=a)&&Object.keys(r.O).every(e=>r.O[e](n[l]))?n.splice(l--,1):(c=!1,a<s&&(s=a));if(c){e.splice(o--,1);var d=i();void 0!==d&&(t=d)}}return t}})(),r.rv=()=>"1.3.8",(()=>{var e={980:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var i,a,[o,s,c]=n,l=0;if(o.some(t=>0!==e[t])){for(i in s)r.o(s,i)&&(r.m[i]=s[i]);if(c)var d=c(r)}for(t&&t(n);l<o.length;l++)a=o[l],r.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return r.O(d)},n=self.webpackChunkidb_cache_app=self.webpackChunkidb_cache_app||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})(),r.ruid="bundler=rspack@1.3.8";var n=r.O(void 0,["361","269"],function(){return r(9639)});n=r.O(n)})();